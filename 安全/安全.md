### 安全

#### XSS

##### 基本概念

`Cross-Site Scripting`（跨域脚本攻击），简称`XSS`，是一种代码注入攻击。攻击者通过在目标网站注入恶意脚本，使之在浏览器上运行。利用这些脚本，攻击者可以获取用户的敏感信息，进而危害系统安全。

##### 常见的攻击方式

- 来自用户的表单输入内容
- 第三方链接
- URL 参数
- POST 参数
- Cookie

##### XSS 分类

根据攻击的来源不同，`XSS`可分为`存储型`，`反射型`，`DOM型`：

###### 存储型 XSS

攻击者将恶意代码提交到目标网站的数据库中，用户打开目标网站后，从数据库中取出恶意代码拼接到`HTML`里，用户浏览器接收到响应后解析执行，恶意代码也被执行。

常见场景：常用于带有用户保存数据的网站功能，如论坛发帖，商品评论，用户私信等

###### 反射型 XSS

反射型与存储型最大的不同点在于：存储型的恶意代码存在数据库中，而反射型的恶意代码存储在 URL 中。攻击者会构造出包含恶意代码的 URL，当用户点击后，服务器会将恶意代码解析出来拼接到`HTML`中返回，用户浏览器接收到响应后解析执行，恶意代码也被执行。

常见场景：常见于通过 URL 传递参数的功能，如网站搜索，跳转等。

由于需要用户主动打开恶意 URL 才能生效，攻击者往往结合多种手段诱导用户点击。

###### DOM 型 XSS

攻击者会构造出包含恶意代码的 URL，当用户点击后，前端`JS`代码会将恶意代码解析出来调用，窃取用户数据。

DOM 型 XSS 攻击中，取出和执行恶意代码都是由浏览器完成，是单纯的前端的安全漏洞。其他两种都是服务端漏洞。

##### 预防 XSS

XSS 攻击有两大要素：

1. 攻击者提交恶意代码
2. 浏览器执行恶意代码

但是由于并不确定用户输入的内容要输出到什么地方，所以输入过滤并不是很靠谱。所以只有通过`浏览器执行恶意代码`来预防 XSS 攻击。有两个思路：

- 防止 HTML 中出现注入（主要预防存储型与反射型 XSS）
- 防止`JS`执行时，执行恶意代码

###### 防止 HTML 中出现注入

存储型和反射型 XSS 都是取出恶意代码后拼接至`HTML`中，服务端渲染（SEO），有两种常见的预防做法：

1. 纯前端渲染，代码数据隔离
2. HTML 做充分转义

###### 防止 JS 执行恶意代码

网站前端 JS 代码不够严谨，不要将未知来源的数据当做代码执行了。

##### 其他 XSS 防范措施

###### CSP

设置严格的 CSP，比如：

- 禁止加载外域代码
- 禁止外域提交
- 禁止未授权脚本执行等。

###### 输入内容长度限制

对于不受信任的输入，都应限定一个合理长度。

###### 其他

- HTTP-only Cookie，禁止`JS`读取敏感 Cookie，攻击者即便完成 XSS 注入后也无法窃取 Cookie。
- 验证码，强制要求用户确认操作

#### CSRF

##### 基本概念

`Cross-site request forgery`跨站请求伪造，攻击者诱导用户进入第三方网站，在第三方网站中，向目标网站发出跨站请求，利用用户在目标网站已经获取的注册凭证，绕过后台的安全验证，达到冒充用户对目标网站操作的目的。

##### 分类

###### GET 型 CSRF

GET 类型的 CSRF 利用非常简单，只需要一个 HTTP 请求，用户点击请求时就会向目标网站发送一次跨站请求；

###### POST 型 CSRF

POST 型的 CSRF 经常使用一个自动提交的表单，访问该页面后，表单自动提交，就相当于模拟用户完成了一次 POST 请求。

###### 链接类型 CSRF

链接类型的 CSRF 需要用户主动点击，这种类型通常是在论坛中发布的图片中嵌入恶意链接，或者以广告的形式诱导用户中招，攻击者通常会以比较夸张的词语诱骗用户点击。

##### 特点

- 攻击发起在第三方网站，被攻击网站无法防止攻击发生。
- 攻击利用用户在被攻击网站的登录凭证模拟用户操作
- 攻击者不能获取受害者的登录凭证
- 跨站请求可以用各种方式，难以追踪
- CSRF 通常是跨域的，如果本域下有容易被利用的功能，比如可以发图，链接功能的论坛和讨论区，攻击可以直接在本域下进行，更加危险

针对上述特点，可以整理防护策略如下：

- 跨域 CSRF 的情况下，拦截跨域请求
- 本域 CSRF 的情况下，对用户上传的内容做校验

##### 跨域 CSRF 防护

###### 同源检测

通过检测 HTTP 请求中携带的`Origin Header`，`Refer Header`确定来源域名，如果非同源，直接进行阻止。

###### CSRF Token

1. 服务器生成一个加密的`Token`，存储在服务器的`session`中
2. 网页所有的请求都要求携带这个 token
3. 服务器进行 token 校验，非法直接阻止

##### 本域 CSRF 防护

- 严格管控所有的上传接口
- 添加 Header `X-Content-Type-Options: nosniff` 防止黑客上传 HTML 内容的资源（例如图片）被解析为网页。
- 对于用户上传的图片，进行转存或校验，不要直接使用用户填写的用户链接
- 当前用户打开其他用户填写的链接时，需告知风险。
