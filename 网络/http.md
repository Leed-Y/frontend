### HTTP

#### 简介

`HTTP`协议定义`Web`客户端如何从`Web`服务端请求网页，以及服务器如何把`Web`页面传送给客户端。`HTTP`协议采用请求/响应模型。客户端向服务器发送一个请求报文，然后服务器以一个状态行作为响应。`HTTP`是不保存状态的协议，也就是说`HTTP`协议对于请求和响应之间的通信状态不进行保存。客户端的状态管理是Cookie技术产生的基本原因。



#### 网络OSI

网络OSI七层模型如下：

- 应用层（文件传输，电子邮件，文件服务等），`TCP/IP` 协议族（`HTTP`，`DNS`）
- 表示层（数据格式话，代码转换，数据加密），无协议
- 会话层（建立会话联系），无协议
- 传输层（提供端与端的接口），`TCP/IP`协议族（`TCP`，`UDP`）
- 网络层（数据包选择路由），`TCP/IP`协议族（`IP`）
- 链路层（传输有地址的帧），`TCP/IP`协议族（`ARP`）
- 物理层（二进制形式在物理媒体上传输数据），`TCP/IP`协议族（`ISO`）

Web应用通信传输流的发送端在层与层之间传输数据时，每经过一层时会被打上该层的首部信息。反之，接受端在层与层之间传输数据时，每经过一层时会把对应的头信息去掉。



#### TCP/IP 协议族

`TCP/IP`协议族是最基本的协议，`HTTP`协议是其一个子集。`TCP/IP`协议族按层次分为以下四层：

##### 应用层

应用层规定了用户直接使用的一些协议，包含了：`DNS`（域名系统提供域名）以及`HTTP`协议。

##### 传输层

传输层包含两个性质不同的协议：`TCP`协议，`UDP`协议。

###### TCP协议

`TCP`协议是发送数据和接受数据是同步进行的，所以`TCP`协议在开始连接和结束连接时需要做出确认动作，也就是常说的`三次握手，四次挥手`。

`三次握手`，其基本流程如下：

1. 客户端向服务端发送`SYN`消息，客户端进入`SYN_SEND`状态，确认客户端发送消息的能力
2. 服务端收到`SYN`消息后，服务端将`SYN`，`ACK`发送消息到客户端，确认服务器接受消息的能力和服务器发送消息的能力
3. 客户端收到`SYN`，`ACK`消息后，发送`ACK`消息到服务端，确认客户端接受消息的能力，完成三次握手

`四次挥手`，其基本流程如下：

1. 主机1向主机2发送一个消息发送完毕的`FIN`报文，主机1进入`FIN_WAIT_1`状态。
2. 主机2接受到主机1发送的`FIN`报文，主机2回复主机1一个`ACK`报文，主机1进入`FIN_WAIT_2`状态。
3. 主机2向主机1发送一个消息发送完毕的`FIN`报文，请求关闭连接，主机2进入`LAST_ACK`状态。
4. 主机1向主机2发送一个`ACK`报文，主机1进入`TIME_WAIT`状态，主机2收到`ACK`后结束连接，主机1等待不到回应后，主机1也关闭。

###### UDP协议

`UDP`协议是无连接的，在正式连接传输数据之前不需要创建连接。`UDP`比`TCP`协议更加高效，轻便。

##### 网络层

网络层规定了数据通过怎样的传输线路到达对方的计算机（`IP`协议）

##### 链路层

用于处理连接网络的硬件部分。



#### HTTP报文

##### 请求方法

- `GET`，一般用于获取服务器资源
- `POST`，一般用于传输实体数据
- `PUT`，一般用于传输文件，修改资源
- `DELETE`，用于删除资源
- `HEAD`，用于获取报文首部，不返回报文主体
- `OPTIONS`，用于预检请求



##### 状态码

`1xx`开头的状态码表示请求处于持续状态中。

- 101，响应客户端的`Upgrade`标头发送，同时指示服务器正在切换的协议
- 102，表示服务器已收到并正在处理该请求。

`2xx`开头的状态码表示请求正常响应。

- 200，请求成功
- 201，创建成功
- 202，请求已经接受到，但还未响应

`3xx`开头的状态码表示响应重定向。

- 300，被请求资源有一系列可供选择的回馈信息，需要用户或浏览器自行选择地址进行重定向
- 301，被请求资源永久移动到新位置，永久重定向
- 302，被请求资源临时从不同的URL上请求，临时重定向
- 303，被请求资源的响应可以在另一URL上找到，为了允许由脚本激活的`POST`请求重定向获取到新的资源
- 304，客户端发送的`GET`请求请求的资源未改变，则返回该状态。

`4xx`开头的状态码表示客户端异常。

- 400，请求参数有误
- 401，用户验证失败
- 403，服务器拒绝执行
- 404，请求失败，请求资源未发现
- 405，请求方法不允许

`5xx`开头的状态码表示服务端异常。

- 500，服务端异常
- 501，请求方法不支持
- 502，网关异常



#### Cookie与Session的区别

`Cookie`是一种发送到客户浏览器的凭证，用于保存WEB站点会话间持久的保持数据。

`Session`指的是访问者访问一个主页，服务器创建了一个`Session`，同时在浏览器上创建了一个`Cookie`，等到`Session`结束后，这个`Cookie`也过期。

`Cookie`与`Session`的异同：

- 相同处：都是用于追踪用户身份的会话方式
- 不同处：`Cookie`数据保存在客户端，`Session`数据保存在服务端。



#### 浏览器缓存

浏览器缓存分为：强缓存与协商缓存。

##### 强缓存

###### 强缓存的流程

1. 查看`header`里的`Expire`和`Cache-control`判断缓存是否过期
2. 缓存未过期时，返回缓存数据
3. 缓存过期时，发送请求返回数据，将新数据存入缓存

###### 强缓存的头信息

- `Expire`，该字段包含了一个绝对时间，过了这个时间，缓存失效
- `Cache-Control`，可以通过`max-age`设置有效时间，这是相对时间。

##### 协商缓存

###### 协商缓存的流程

1. 强缓存未命中时，会发送一个请求发送到服务端
2. 把资源标识，`If-Modify-Since` 或 `Etag` 发送到服务器，确认资源是否更新
3. 如果资源未更新，请求响应状态码为`304`，告诉浏览器使用本地缓存
4. 如果资源已更新，返回数据，将新数据存入缓存

###### 协商缓存的头信息

- `Last-Modified`，`If-Modified-Since`，当浏览器第一次请求资源时，返回的`header`上带上一个`Last-Modified`字段表示资源最后修改的时间。当浏览器再次请求该资源时，会将`Last-Modified`的值作为`If-Modified-Since`作为请求头。服务器收到请求后，将请求的`If-Modified-Since`与资源的`Last-Modified`对比，如果存在更新返回更新数据，否则返回`304`
- `Etag`是根据资源文件内容生成的唯一标识，当浏览器第一次请求资源时，返回的`header`上带上一个`Etag`字段表示资源数据。当浏览器再次请求该资源时，会将`Etag`作为`If-no-match`构成请求头。服务器收到请求后，会将`If-no-match`与`Etag`做比较，如果存在更新返回更新数据，否则返回`304`。



#### 输入一个URL，发生了什么事

1. 解析`URL`，`DNS`服务根据`URL`域名做`DNS解析`获取到对应的`IP`，递归查找，从本地域名服务器开始，到根域名，顶级域名服务器，`DNS`缓存类型：浏览器缓存，系统缓存，根域名服务器缓存，顶级域名服务器缓存，主域名服务器缓存。
2. `TCP`连接，三次握手
3. `HTTP`发送请求
4. 请求优先查看`强缓存`，若命中缓存直接返回，否则继续发送请求
5. 请求做`协商缓存`，若数据未更新直接返回`304`，数据更新时返回新数据
6. 服务器处理请求返回`HTTP`报文响应
7. 浏览器解析渲染页面，解析`HTML`生成`DOM`树，解析`CSS`文件构建渲染树。

