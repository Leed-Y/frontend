### 事件机制

#### 事件循环（Event Loop）

**非常重要的是，JavaScript 是单线程语言**，所以在执行代码过程中，所有的代码都只能是一行一行的执行。

`JS`存在一个`主线程`用于执行代码，存在`执行栈（FIFO）`用于存储等待`主线程`调用的`同步任务`，同时存在`任务队列`用于存储等待`主线程`执行的`异步任务`回调函数任务。

整个事件循环的机制如下：

1. 主线程由上而下执行所有代码。
2. 遇到同步任务时，压入`执行栈`，执行同步任务完成后，弹出`执行栈`。
3. 遇到异步任务时，压入`执行栈`，执行异步任务完成后，弹出`执行栈`。同时将异步任务的`回调任务`压入`任务队列`。
4. 主线程将`执行栈`的任务执行完成后，从`执行队列`中读取任务，进入到主线程执行。
5. 循环如上。

#### 任务队列

`任务队列`是一个存储当前异步任务的`回调任务Task`的队列。

#### 同步异步任务

同步任务是主线程来执行时，立即可以执行的代码。

异步任务是让主线程先执行其他任务，等待一段时间后，再执行该任务

示例代码：

```javascript
// 同步Task
console.log("show event loop");

// 异步Task
setTimeout(() => {
  // 异步Task Callback
  console.log("show timeout");
}, 1000);

// 同步Task2
console.log("finish event loop");
```

分析如下：

1. 主线程由上至下执行
2. `同步Task`压入`执行栈`，执行完成之后弹出`执行栈`。
3. `异步Task`压入`执行栈`，执行完成之后弹出`执行栈`。
4. `同步Task2`压入`执行栈`，执行完成之后弹出`执行栈`。
5. 1s 后`异步任务Task Callback`压入`任务队列`。
6. 主线程在`任务队列`中查找可执行的任务，执行任务。

#### 宏任务（MacroTask）与微任务（MicroTask）

`宏任务`与`微任务`是`任务队列`中的两种任务类型，虽然`任务队列`中的所有`Task`众生平等，但有些`Task`更加平等。在主线程在`任务队列`中查找可执行的`Task`时，会优先选取`微任务`。

`微任务` 包括：`Process.nextTick`,`Promise.then`, `Promise.catch`, `Promise.finally`。

示例代码：

```javascript
// 同步Task
console.log("diff macroTask MicroTask");

// 异步Task1
setTimeout(() => {
  // 宏任务
  console.log(1);
}, 0);

// 异步Task2
new Promise((resolve) => {
  // 微任务1
  console.log(2);
  resolve();
})
  .then(() => {
    // 微任务2
    console.log(3);
  })
  .finally(() => {
    // 微任务3
    console.log(4);
  });
```

分析如下：

1. 主线程由上至下执行代码。
2. 将`同步Task`压入`执行栈`，执行完成之后弹出`执行栈`。
3. 将`异步Task1`压入`执行栈`，执行完成后弹出`执行栈`，并将`宏任务`压入`执行队列`。
4. 将`异步Task2`压入`执行栈`，执行完成后弹出`执行栈`，并依次将`微任务1`，`微任务2`，`微任务3`压入`执行队列`。
5. 主线程从`执行队列`中查找可执行的`Task`，优先查找`微任务`，其后`宏任务`。
6. 依次执行`微任务1`，`微任务2`，`微任务3`，`宏任务`。
